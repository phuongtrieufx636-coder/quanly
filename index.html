<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n L√Ω Kho ƒêi·ªán Tho·∫°i</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --line:#e5e7eb;
      --accent:#2563eb;
      --accent-weak:#eff6ff;
      --danger:#ef4444;
      --success:#16a34a;
      --warning:#d97706;
      --shadow:0 6px 24px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:var(--bg);
      margin:0;
      line-height:1.45;
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap
    }
    h1{font-size:24px;margin:0}
    .pill{
      padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted);
      display:inline-flex;gap:6px;align-items:center;
    }
    .grid{display:grid;gap:14px}
    @media (min-width:900px){ .grid-2{grid-template-columns:1.2fr .8fr} }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{font-size:18px;margin:0 0 10px 0}
    form .row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    @media (max-width:720px){ form .row{grid-template-columns:repeat(2,1fr)} }
    form .row > div{display:flex;flex-direction:column}
    label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{
      border:1px solid var(--line); border-radius:10px; padding:10px; font-size:14px; background:#fff; color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--accent-weak)}
    button{
      border:1px solid var(--line); background:#fff; color:var(--text); border-radius:10px; padding:10px 14px;
      font-size:14px; cursor:pointer;
    }
    .btn-primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn-danger{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn-outline{background:#fff}
    .btn-ghost{background:transparent;border-color:transparent;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 0 0}
    .stat{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    .stat .big{font-weight:700;font-size:18px}
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:14px;background:#fff}
    th, td{padding:10px;border-bottom:1px solid var(--line);white-space:nowrap}
    th{position:sticky;top:0;background:#f8fafc;text-align:left;font-weight:700;color:#0f172a}
    tr:hover td{background:#fafafa}
    .right{text-align:right}
    .center{text-align:center}
    .muted{color:var(--muted)}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);display:inline-block}
    .bd-success{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .bd-danger{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .bd-warning{background:#fffbeb;color:#92400e;border-color:#fde68a}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:10px 10px 0 0;border:1px solid var(--line);border-bottom:none;background:#fff;cursor:pointer}
    .tab.active{background:#f8fafc;font-weight:700}
    .srch{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .hidden{display:none !important}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{height:6px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .foot{margin-top:8px;color:var(--muted);font-size:12px}
    .danger-zone{display:flex;gap:8px;flex-wrap:wrap}
    dialog::backdrop{background:rgba(0,0,0,.12);}
    dialog{border:none;border-radius:16px;box-shadow:var(--shadow);padding:0;max-width:520px;width:90%}
    .modal{padding:16px}
    .modal header{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:700}
    .modal .body{padding:12px 16px}
    .modal footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>üì¶ Qu·∫£n L√Ω Kho ƒêi·ªán Tho·∫°i</h1>
      <div class="pill"><span class="mono">LocalStorage</span><span>‚Ä¢</span><span id="deviceInfo">Thi·∫øt b·ªã: ...</span></div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <h2>Nh·∫≠p m√°y (Th√™m v√†o kho)</h2>
        <form id="formAdd">
          <div class="row">
            <div>
              <label for="imei">IMEI *</label>
              <input id="imei" required placeholder="S·ªë IMEI duy nh·∫•t" />
            </div>
            <div>
              <label for="model">Model *</label>
              <input id="model" required placeholder="VD: iPhone 13 128GB" />
            </div>
            <div>
              <label for="color">M√†u s·∫Øc</label>
              <input id="color" placeholder="ƒêen / Tr·∫Øng / Xanh..." />
            </div>
            <div>
              <label for="condition">T√¨nh tr·∫°ng (ƒë·∫πp %) *</label>
              <input id="condition" type="number" min="50" max="100" step="1" value="95" required />
            </div>
            <div>
              <label for="buyPrice">Gi√° nh·∫≠p (ƒë)</label>
              <input id="buyPrice" type="number" min="0" step="1000" placeholder="VD: 8,500,000" />
            </div>
            <div>
              <label for="dateIn">Ng√†y nh·∫≠p</label>
              <input id="dateIn" type="date" />
            </div>
            <div style="grid-column:1 / -1">
              <label for="note">Ghi ch√∫</label>
              <input id="note" placeholder="Ph·ª• ki·ªán, pin %, b·∫£o h√†nh..." />
            </div>
          </div>
          <div class="spacer"></div>
          <div class="toolbar">
            <button class="btn btn-primary" type="submit">‚ûï Th√™m m√°y</button>
            <button class="btn btn-outline" type="reset">L√†m m·ªõi</button>
            <span class="muted">* IMEI l√† duy nh·∫•t. Tr√πng IMEI s·∫Ω kh√¥ng ƒë∆∞·ª£c th√™m.</span>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>T·ªïng quan</h2>
        <div class="stats">
          <div class="stat">
            <div class="muted">ƒêang t·ªìn</div>
            <div id="s_instock" class="big">0</div>
          </div>
          <div class="stat">
            <div class="muted">V·ªën t·ªìn (ƒë)</div>
            <div id="s_capital" class="big">0</div>
          </div>
          <div class="stat">
            <div class="muted">Doanh thu (ƒë)</div>
            <div id="s_revenue" class="big">0</div>
          </div>
          <div class="stat">
            <div class="muted">L√£i/L·ªó (ƒë)</div>
            <div id="s_profit" class="big">0</div>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="toolbar">
          <button id="btnExportCSV" class="btn">üì§ Xu·∫•t CSV</button>
          <label class="btn btn-outline" for="importCsv">üì• Nh·∫≠p CSV</label>
          <input id="importCsv" type="file" accept=".csv,text/csv" class="hidden" />
          <button id="btnReset" class="btn btn-danger">üßπ X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
        </div>
        <div class="foot">D·ªØ li·ªáu ch·ªâ l∆∞u t·∫°i tr√¨nh duy·ªát (localStorage). H√£y xu·∫•t CSV ƒë·ªÉ sao l∆∞u ƒë·ªãnh k·ª≥.</div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div id="tabStock" class="tab active">üìã Danh s√°ch t·ªìn kho</div>
        <div id="tabSold" class="tab">üßæ L·ªãch s·ª≠ xu·∫•t / b√°n</div>
      </div>

      <div id="viewStock">
        <div class="toolbar">
          <div class="srch grow">
            <input id="q" class="grow" placeholder="T√¨m theo IMEI, Model, M√†u..." />
            <select id="filterStatus">
              <option value="">Tr·∫°ng th√°i</option>
              <option value="instock">ƒêang t·ªìn</option>
              <option value="hold">Gi·ªØ h√†ng</option>
            </select>
            <select id="filterCondition">
              <option value="">T√¨nh tr·∫°ng</option>
              <option value="99">‚â• 99%</option>
              <option value="97">‚â• 97%</option>
              <option value="95">‚â• 95%</option>
              <option value="90">‚â• 90%</option>
            </select>
          </div>
          <div class="flex">
            <button id="btnHoldToggle" class="btn btn-outline">‚è∏Ô∏è Chuy·ªÉn gi·ªØ h√†ng</button>
            <button id="btnDeleteSelected" class="btn btn-danger">üóëÔ∏è X√≥a ƒë√£ ch·ªçn</button>
          </div>
        </div>
        <div class="table-wrap">
          <table id="tblStock">
            <thead>
              <tr>
                <th class="center"><input type="checkbox" id="chkAll" /></th>
                <th>IMEI</th>
                <th>Model</th>
                <th>M√†u</th>
                <th class="right">ƒê·∫πp %</th>
                <th class="right">Gi√° nh·∫≠p</th>
                <th>Ng√†y nh·∫≠p</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
                <th class="center">Thao t√°c</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="viewSold" class="hidden">
        <div class="toolbar">
          <div class="srch grow">
            <input id="qSold" class="grow" placeholder="T√¨m theo IMEI / Model / Ng∆∞·ªùi mua..." />
          </div>
          <div class="flex">
            <span class="pill">T·ªïng l√£i/l·ªó: <b class="mono" id="sumProfitSold">0</b> ƒë</span>
          </div>
        </div>
        <div class="table-wrap">
          <table id="tblSold">
            <thead>
              <tr>
                <th>#</th>
                <th>IMEI</th>
                <th>Model</th>
                <th>M√†u</th>
                <th class="right">ƒê·∫πp %</th>
                <th class="right">Gi√° nh·∫≠p</th>
                <th class="right">Gi√° b√°n</th>
                <th>Ng√†y b√°n</th>
                <th>Ng∆∞·ªùi mua</th>
                <th class="right">L√£i/L·ªó</th>
                <th>Ghi ch√∫</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>C√†i ƒë·∫∑t nhanh</h2>
      <div class="toolbar">
        <div class="pill">Ti·ªÅn t·ªá hi·ªÉn th·ªã: <select id="currency">
          <option value="ƒë" selected>ƒë (VND)</option>
          <option value="$">$</option>
        </select></div>
        <div class="pill">ƒê·ªãnh d·∫°ng s·ªë: <select id="thousand">
          <option value=",">D·∫•u ph·∫©y ,</option>
          <option value=".">D·∫•u ch·∫•m .</option>
          <option value=" ">Kho·∫£ng tr·∫Øng</option>
        </select></div>
      </div>
    </div>

    <dialog id="dlgSell">
      <div class="modal">
        <header>Xu·∫•t / B√°n m√°y</header>
        <div class="body">
          <div class="row" style="grid-template-columns:repeat(2,1fr)">
            <div>
              <label for="sellPrice">Gi√° b√°n (ƒë) *</label>
              <input id="sellPrice" type="number" min="0" step="1000" required />
            </div>
            <div>
              <label for="sellDate">Ng√†y b√°n *</label>
              <input id="sellDate" type="date" required />
            </div>
            <div>
              <label for="buyer">Ng∆∞·ªùi mua</label>
              <input id="buyer" placeholder="T√™n / SƒêT" />
            </div>
            <div>
              <label for="sellNote">Ghi ch√∫</label>
              <input id="sellNote" placeholder="Ph·ª• ki·ªán t·∫∑ng k√®m..." />
            </div>
          </div>
          <div class="spacer"></div>
          <div class="pill">L·ª£i nhu·∫≠n d·ª± ki·∫øn: <b class="mono" id="previewProfit">0</b> ƒë</div>
        </div>
        <footer>
          <button class="btn btn-ghost" id="btnCancelSell">H·ªßy</button>
          <button class="btn btn-primary" id="btnConfirmSell">X√°c nh·∫≠n b√°n</button>
        </footer>
      </div>
    </dialog>

  </div>

  <script>
    // ===== Utilities =====
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const fmt = (n, sym = getCurrency(), sep = getThousand()) => {
      if (n === null || n === undefined || isNaN(n)) return '0 ' + sym;
      const abs = Math.abs(n);
      const sign = n < 0 ? '-' : '';
      return sign + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, sep) + ' ' + sym;
    };
    const uid = () => Math.random().toString(36).slice(2,10);
    const today = () => new Date().toISOString().slice(0,10);
    const getCurrency = () => localStorage.getItem('cfg_currency') || 'ƒë';
    const getThousand = () => localStorage.getItem('cfg_thousand') || ',';
    const saveCfg = () => {
      localStorage.setItem('cfg_currency', $('#currency').value);
      localStorage.setItem('cfg_thousand', $('#thousand').value);
      renderAll();
    };

    // ===== Device detection =====
    function detectDevice(){
      const ua = navigator.userAgent || '';
      const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Windows Phone|Mobi/i.test(ua);
      const isSmall = Math.min(screen.width, window.innerWidth) <= 820;
      const isMobile = isMobileUA || isSmall;
      document.body.classList.toggle('is-mobile', isMobile);
      $('#deviceInfo').textContent = 'Thi·∫øt b·ªã: ' + (isMobile ? 'Mobile' : 'Desktop');
      return isMobile;
    }
    window.addEventListener('resize', detectDevice);

    // ===== Storage =====
    const KEY = 'phone_inventory_v1';
    function loadData(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return {items:[], sold:[]};
        const obj = JSON.parse(raw);
        if(!obj.items) obj.items = [];
        if(!obj.sold) obj.sold = [];
        return obj;
      }catch(e){ return {items:[], sold:[]}; }
    }
    function saveData(db){ localStorage.setItem(KEY, JSON.stringify(db)); }

    let DB = loadData();
    let currentSellImei = null;

    // ===== Add item =====
    $('#dateIn').value = today();
    $('#formAdd').addEventListener('submit', (e)=>{
      e.preventDefault();
      const imei = $('#imei').value.trim();
      if(!imei){ alert('Vui l√≤ng nh·∫≠p IMEI'); return; }
      if(DB.items.some(x=>x.imei === imei) || DB.sold.some(x=>x.imei === imei)){
        alert('IMEI ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!'); return;
      }
      const item = {
        id: uid(),
        imei,
        model: $('#model').value.trim(),
        color: $('#color').value.trim(),
        condition: Number($('#condition').value||0),
        buyPrice: Number($('#buyPrice').value||0),
        dateIn: $('#dateIn').value || today(),
        note: $('#note').value.trim(),
        status: 'instock', // instock | hold
        createdAt: Date.now()
      };
      DB.items.push(item);
      saveData(DB);
      e.target.reset();
      $('#condition').value = 95;
      $('#dateIn').value = today();
      renderAll();
    });

    // ===== Tabs =====
    const tabStock = $('#tabStock'), tabSold = $('#tabSold');
    const viewStock = $('#viewStock'), viewSold = $('#viewSold');
    tabStock.addEventListener('click', ()=>{ tabStock.classList.add('active'); tabSold.classList.remove('active'); viewStock.classList.remove('hidden'); viewSold.classList.add('hidden'); });
    tabSold.addEventListener('click', ()=>{ tabSold.classList.add('active'); tabStock.classList.remove('active'); viewSold.classList.remove('hidden'); viewStock.classList.add('hidden'); });

    // ===== Filters =====
    $('#q').addEventListener('input', renderStock);
    $('#filterStatus').addEventListener('change', renderStock);
    $('#filterCondition').addEventListener('change', renderStock);
    $('#qSold').addEventListener('input', renderSold);

    // ===== Bulk actions =====
    $('#chkAll').addEventListener('change', (e)=> {
      $$('#tblStock tbody input[type="checkbox"]').forEach(c=> c.checked = e.target.checked);
    });
    $('#btnDeleteSelected').addEventListener('click', ()=>{
      const ids = $$('#tblStock tbody input[type="checkbox"]:checked').map(c=>c.dataset.id);
      if(ids.length===0) { alert('Ch∆∞a ch·ªçn m·ª•c n√†o'); return; }
      if(!confirm('X√≥a ' + ids.length + ' m√°y ƒë√£ ch·ªçn?')) return;
      DB.items = DB.items.filter(x=> !ids.includes(x.id));
      saveData(DB); renderAll();
    });
    $('#btnHoldToggle').addEventListener('click', ()=>{
      const ids = $$('#tblStock tbody input[type="checkbox"]:checked').map(c=>c.dataset.id);
      if(ids.length===0) { alert('Ch∆∞a ch·ªçn m·ª•c n√†o'); return; }
      DB.items = DB.items.map(x=> ids.includes(x.id) ? {...x, status: x.status==='hold'?'instock':'hold'} : x);
      saveData(DB); renderStock();
    });

    // ===== Sell modal =====
    const dlgSell = $('#dlgSell');
    $('#btnCancelSell').addEventListener('click', ()=> dlgSell.close());
    $('#sellPrice').addEventListener('input', previewProfit);
    function openSellDialog(imei, buyPrice){
      currentSellImei = imei;
      $('#sellDate').value = today();
      $('#sellPrice').value = '';
      $('#buyer').value = '';
      $('#sellNote').value = '';
      $('#previewProfit').textContent = fmt(0);
      dlgSell.showModal();
      $('#sellPrice').focus();
      // Store buyPrice to compute preview
      $('#sellPrice').dataset.buyPrice = String(buyPrice||0);
    }
    function previewProfit(){
      const p = Number($('#sellPrice').value||0);
      const b = Number($('#sellPrice').dataset.buyPrice||0);
      $('#previewProfit').textContent = fmt(p-b);
    }
    $('#btnConfirmSell').addEventListener('click', ()=>{
      const price = Number($('#sellPrice').value||0);
      const date = $('#sellDate').value;
      if(price<=0 || !date){ alert('Vui l√≤ng nh·∫≠p gi√° b√°n v√† ng√†y b√°n'); return; }
      const idx = DB.items.findIndex(x=>x.imei===currentSellImei);
      if(idx<0){ alert('Kh√¥ng t√¨m th·∫•y m√°y'); return; }
      const it = DB.items[idx];
      const sold = {
        ...it,
        sellPrice: price,
        dateOut: date,
        buyer: $('#buyer').value.trim(),
        sellNote: $('#sellNote').value.trim(),
        profit: price - (Number(it.buyPrice)||0),
        soldAt: Date.now()
      };
      DB.sold.push(sold);
      DB.items.splice(idx,1);
      saveData(DB);
      dlgSell.close();
      renderAll();
      tabSold.click();
    });

    // ===== Render Stock =====
    function renderStock(){
      const tbody = $('#tblStock tbody');
      tbody.innerHTML = '';
      const q = $('#q').value.toLowerCase();
      const fs = $('#filterStatus').value;
      const fc = $('#filterCondition').value;
      let list = DB.items.slice().sort((a,b)=> b.createdAt - a.createdAt);
      if(q) list = list.filter(x =>
        x.imei.toLowerCase().includes(q) ||
        (x.model||'').toLowerCase().includes(q) ||
        (x.color||'').toLowerCase().includes(q)
      );
      if(fs) list = list.filter(x => x.status === fs);
      if(fc) list = list.filter(x => Number(x.condition||0) >= Number(fc));

      for(const it of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center"><input type="checkbox" data-id="${it.id}"></td>
          <td class="mono">${it.imei}</td>
          <td>${it.model||''}</td>
          <td>${it.color||''}</td>
          <td class="right">${Number(it.condition||0)}%</td>
          <td class="right">${fmt(Number(it.buyPrice||0))}</td>
          <td>${it.dateIn||''}</td>
          <td>
            ${it.status==='hold' ? '<span class="badge bd-warning">Gi·ªØ h√†ng</span>' : '<span class="badge bd-success">ƒêang t·ªìn</span>'}
          </td>
          <td>${it.note||''}</td>
          <td class="center">
            <button class="btn btn-outline" data-act="edit" data-id="${it.id}">‚úèÔ∏è S·ª≠a</button>
            <button class="btn btn-primary" data-act="sell" data-imei="${it.imei}">üí≥ B√°n</button>
            <button class="btn btn-danger" data-act="del" data-id="${it.id}">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // row actions
      tbody.querySelectorAll('button[data-act="sell"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const it = DB.items.find(x=>x.imei === btn.dataset.imei);
          openSellDialog(it.imei, Number(it.buyPrice||0));
        });
      });
      tbody.querySelectorAll('button[data-act="del"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if(!confirm('X√≥a m√°y n√†y?')) return;
          DB.items = DB.items.filter(x=> x.id !== btn.dataset.id);
          saveData(DB); renderAll();
        });
      });
      tbody.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.id;
          const it = DB.items.find(x=> x.id===id);
          const model = prompt('Model:', it.model||'');
          if(model===null) return;
          const color = prompt('M√†u:', it.color||'');
          if(color===null) return;
          const condition = prompt('T√¨nh tr·∫°ng (%):', String(it.condition||95));
          if(condition===null) return;
          const buyPrice = prompt('Gi√° nh·∫≠p:', String(it.buyPrice||0));
          if(buyPrice===null) return;
          const note = prompt('Ghi ch√∫:', it.note||'');
          if(note===null) return;
          it.model = model.trim();
          it.color = color.trim();
          it.condition = Number(condition||0);
          it.buyPrice = Number(buyPrice||0);
          it.note = note.trim();
          saveData(DB); renderStock(); updateStats();
        });
      });
    }

    // ===== Render Sold =====
    function renderSold(){
      const tbody = $('#tblSold tbody');
      tbody.innerHTML = '';
      const q = $('#qSold').value.toLowerCase();
      let list = DB.sold.slice().sort((a,b)=> b.soldAt - a.soldAt);
      if(q){
        list = list.filter(x =>
          x.imei.toLowerCase().includes(q) ||
          (x.model||'').toLowerCase().includes(q) ||
          (x.buyer||'').toLowerCase().includes(q)
        );
      }
      let sumProfit = 0;
      list.forEach((it,idx)=>{
        sumProfit += Number(it.profit||0);
        const tr = document.createElement('tr');
        const badge = (it.profit||0) >= 0 ? '<span class="badge bd-success">L√£i</span>' : '<span class="badge bd-danger">L·ªó</span>';
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td class="mono">${it.imei}</td>
          <td>${it.model||''}</td>
          <td>${it.color||''}</td>
          <td class="right">${Number(it.condition||0)}%</td>
          <td class="right">${fmt(Number(it.buyPrice||0))}</td>
          <td class="right">${fmt(Number(it.sellPrice||0))}</td>
          <td>${it.dateOut||''}</td>
          <td>${it.buyer||''}</td>
          <td class="right">${fmt(Number(it.profit||0))} ${badge}</td>
          <td>${it.sellNote||''}</td>
          <td class="center"><button class="btn btn-outline" data-act="undo" data-imei="${it.imei}">‚Ü©Ô∏è Ho√†n t√°c</button></td>
        `;
        tbody.appendChild(tr);
      });
      $('#sumProfitSold').textContent = fmt(sumProfit);
      tbody.querySelectorAll('button[data-act="undo"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const imei = btn.dataset.imei;
          const idx = DB.sold.findIndex(x=>x.imei===imei);
          if(idx<0) return;
          if(!confirm('Ho√†n t√°c b√°n v√† tr·∫£ v·ªÅ kho?')) return;
          const it = DB.sold[idx];
          const back = {
            id: uid(),
            imei: it.imei,
            model: it.model,
            color: it.color,
            condition: it.condition,
            buyPrice: it.buyPrice,
            dateIn: it.dateIn,
            note: it.note,
            status: 'instock',
            createdAt: Date.now()
          };
          DB.items.push(back);
          DB.sold.splice(idx,1);
          saveData(DB); renderAll(); tabStock.click();
        });
      });
    }

    // ===== Stats =====
    function updateStats(){
      const instock = DB.items.length;
      const capital = DB.items.reduce((s,x)=> s + Number(x.buyPrice||0), 0);
      const revenue = DB.sold.reduce((s,x)=> s + Number(x.sellPrice||0), 0);
      const profit = DB.sold.reduce((s,x)=> s + Number(x.profit||0), 0);
      $('#s_instock').textContent = instock;
      $('#s_capital').textContent = fmt(capital);
      $('#s_revenue').textContent = fmt(revenue);
      $('#s_profit').textContent = fmt(profit);
    }

    // ===== Export CSV =====
    function downloadFile(filename, text){
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    $('#btnExportCSV').addEventListener('click', ()=>{
      // Export two sheets style: items + sold in one file with markers
      const esc = s => ('"'+ String(s??'').replace(/"/g,'""') + '"');
      const itemsHead = ['imei','model','color','condition','buyPrice','dateIn','note','status'];
      const soldHead = ['imei','model','color','condition','buyPrice','sellPrice','dateIn','dateOut','buyer','profit','note','sellNote'];
      const itemsCsv = [itemsHead.join(',')].concat(DB.items.map(it=> itemsHead.map(k=> esc(it[k])).join(','))).join('\n');
      const soldCsv = [soldHead.join(',')].concat(DB.sold.map(it=> soldHead.map(k=> esc(it[k])).join(','))).join('\n');
      const out = '===TON KHO===\n' + itemsCsv + '\n\n===DA BAN===\n' + soldCsv;
      downloadFile('kho_dien_thoai.csv', out);
    });

    // ===== CSV Parser (simple, quoted values supported) =====
    function parseCSV(text){
      // Split into lines, keep non-empty
      const lines = text.replace(/\r/g,'').split('\n');
      // Helper to parse a single CSV line with quotes
      function parseLine(line){
        const res = [];
        let cur = '';
        let inQ = false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(inQ){
            if(ch === '"'){
              if(line[i+1] === '"'){ cur += '"'; i++; }
              else { inQ = false; }
            } else {
              cur += ch;
            }
          } else {
            if(ch === '"'){ inQ = true; }
            else if(ch === ','){ res.push(cur); cur = ''; }
            else { cur += ch; }
          }
        }
        res.push(cur);
        return res.map(s=>s.trim());
      }
      return lines.filter(l=>l.trim().length>0).map(parseLine);
    }

    // ===== Import CSV =====
    $('#importCsv').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const txt = String(reader.result);
          // Support two modes:
          // 1) Combined file with sections "===TON KHO===" and "===DA BAN==="
          // 2) Single table CSV with headers (either items or sold)
          const hasMarkers = /===TON KHO===/i.test(txt) || /===DA BAN===/i.test(txt);
          let newItems = [];
          let newSold = [];
          if(hasMarkers){
            const parts = txt.split(/===DA BAN===/i);
            const tonPart = parts[0].split(/===TON KHO===/i)[1] || '';
            const daBanPart = parts[1] || '';
            const itemsRows = parseCSV(tonPart);
            const soldRows = parseCSV(daBanPart);
            newItems = csvRowsToItems(itemsRows);
            newSold  = csvRowsToSold(soldRows);
          } else {
            // Single CSV table: detect by header columns
            const rows = parseCSV(txt);
            const header = rows[0].map(h=>h.toLowerCase());
            if(header.includes('sellprice') || header.includes('buyer') || header.includes('dateout')){
              newSold = csvRowsToSold(rows);
            } else {
              newItems = csvRowsToItems(rows);
            }
          }
          if(!confirm('Nh·∫≠p CSV s·∫Ω ghi ƒë√® d·ªØ li·ªáu hi·ªán t·∫°i. Ti·∫øp t·ª•c?')) return;
          DB = { items: newItems, sold: newSold };
          saveData(DB); renderAll();
          alert('Nh·∫≠p CSV th√†nh c√¥ng.');
        }catch(err){
          alert('Kh√¥ng th·ªÉ nh·∫≠p CSV: ' + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value='';
    });

    function csvRowsToItems(rows){
      if(!rows || rows.length<2) return [];
      const head = rows[0].map(x=>x.toLowerCase());
      const idx = name => head.indexOf(name);
      const out = [];
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        if(r.length===1 && r[0]==='') continue;
        const rec = {
          id: uid(),
          imei: r[idx('imei')] || '',
          model: r[idx('model')] || '',
          color: r[idx('color')] || '',
          condition: Number(r[idx('condition')] || 0),
          buyPrice: Number(r[idx('buyprice')] || 0),
          dateIn: r[idx('datein')] || '',
          note: r[idx('note')] || '',
          status: (r[idx('status')] || 'instock').toLowerCase()==='hold'?'hold':'instock',
          createdAt: Date.now()
        };
        if(rec.imei) out.push(rec);
      }
      return out;
    }
    function csvRowsToSold(rows){
      if(!rows || rows.length<2) return [];
      const head = rows[0].map(x=>x.toLowerCase());
      const idx = name => head.indexOf(name);
      const out = [];
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        if(r.length===1 && r[0]==='') continue;
        const rec = {
          id: uid(),
          imei: r[idx('imei')] || '',
          model: r[idx('model')] || '',
          color: r[idx('color')] || '',
          condition: Number(r[idx('condition')] || 0),
          buyPrice: Number(r[idx('buyprice')] || 0),
          dateIn: r[idx('datein')] || '',
          note: r[idx('note')] || '',
          status: 'sold',
          sellPrice: Number(r[idx('sellprice')] || 0),
          dateOut: r[idx('dateout')] || '',
          buyer: r[idx('buyer')] || '',
          profit: Number(r[idx('profit')] || 0),
          sellNote: r[idx('sellnote')] || '',
          soldAt: Date.now()
        };
        if(rec.imei) out.push(rec);
      }
      return out;
    }

    // ===== Settings =====
    $('#currency').value = getCurrency();
    $('#thousand').value = getThousand();
    $('#currency').addEventListener('change', saveCfg);
    $('#thousand').addEventListener('change', saveCfg);

    // ===== Initial render =====
    function renderAll(){
      renderStock();
      renderSold();
      updateStats();
    }
    detectDevice();
    $('#dateIn').value = today();
    renderAll();
  </script>
</body>
</html>
